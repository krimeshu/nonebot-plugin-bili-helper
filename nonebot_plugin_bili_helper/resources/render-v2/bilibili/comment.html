<!DOCTYPE html>

<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1"
/>
<style>
  template {
    display: none;
  }
</style>

<body>
  <placeholder id="template_list"></placeholder>
  <placeholder id="scripts_list"></placeholder>
  <placeholder id="page_data"></placeholder>
  <placeholder id="res_path"></placeholder>

  <script>
    const {
      cleanupBeforeRender,
      cleanupAfterRender,
    } = window.ScriptsModule;
    const {
      Renderer,
    } = window.RendererModule;
    const {
      numberReadable,
      bilibiliReplies,
    } = window.FormatterBilibili;

    class PageComment {
      url = new URL(window.location.href);

      async fetchData() {
        const data = document.getElementById('page_data').textContent;
        const pageData = JSON.parse(data);
        const { videoInfo, comments } = pageData;
        comments.data.replies = comments.data.replies.slice(0, 3);
        return { videoInfo, comments };
      }

      async render() {
        const nowHour = new Date().getHours();
        const defaultTheme = (nowHour >= 7 && nowHour <= 19) ? 'light' : 'dark';

        try {
          console.log('Rendering page...');
          const { videoInfo, comments } = await this.fetchData();
          const theme = this.url.searchParams.get('theme') || defaultTheme;
          const shareUrl = `https://b23.tv/${videoInfo.data.bvid}`;
          const renderer = new Renderer('bilibili/comment', {
            renderScale: 100,
          });
          const data = {
            // _res_path: `${window.location.origin}/resources/`,
            // _res_path: '../../',
            _res_path: document.getElementById('res_path').textContent,
            Type: '视频',
            CommentsData: bilibiliReplies(comments, { theme }),
            CommentLength: numberReadable(videoInfo.data.stat.reply, '无法获取'),
            share_url: shareUrl,
            Clarity: '?',
            VideoSize: '?',
            ImageLength: 0,
            shareurl: shareUrl,
          };
          console.log('Render data:', data);
          const html = renderer.render(data, { theme });
          const replaceScriptQueue = [];
          const replaceNode = (src, dest) => {
            const scripts = Array.from(src.querySelectorAll('script'));
            // console.log('scripts:', scripts);
            scripts.forEach((s) => {
              s.parentNode.removeChild(s);
              replaceScriptQueue.push([src, s]);
            });
            dest.replaceWith(src);
          };
          const doc = new DOMParser().parseFromString(html, 'text/html');
          replaceNode(doc.head, document.head);
          replaceNode(doc.body, document.body);
          // document.head.replaceWith(doc.head);
          // document.body.replaceWith(doc.body);
          // Array.from(doc.head.children).forEach(el => document.head.appendChild(el));
          // Array.from(doc.body.children).forEach(el => document.body.appendChild(el));
          const addScript = (p, s) => new Promise((resolve, reject) => {
            const ns = document.createElement('script');
            if (s.src) {
              ns.src = s.src;
              ns.onload = () => resolve(true);
              ns.onerror = () => reject(new Error(`Failed to load script: ${ns.src || 'inline script'}`));
            } else {
              ns.textContent = s.textContent;
              setTimeout(() => resolve(true), 0);
            }
            p.appendChild(ns);
          });
          window.setTimeout(() => {
            replaceScriptQueue.reduce((p, [t, s]) => p.then(() => addScript(t, s)), Promise.resolve())
              .then(() => {
                window.onload?.();
              });
            // scripts.forEach((s) => {
            //   // src.appendChild(s);
            // });
          }, 0);
          cleanupAfterRender();
        } catch (ex) {
          console.error('Error rendering page:', ex);
          this.createScript('render-result', 'json', {
            code: 1,
            message: ex.message,
          });
        }
      }

      createScript(id, type, data) {
        const pre = document.createElement('pre');
        const box = document.createElement('code');
        box.id = id;
        box.setAttribute('data-type', type);
        box.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        pre.appendChild(box);
        document.body.appendChild(pre);
      }
    }

    async function main() {
      const page = new PageComment();
      await page.render();
    }

    main();
  </script>
</body>